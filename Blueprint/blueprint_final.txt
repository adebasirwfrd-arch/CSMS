CSMS APPLICATION BLUEPRINT
==========================
Version: 1.1.0
Date: 2026-02-08
Generated by: Antigravity AI

1. EXECUTIVE SUMMARY
--------------------
The CSMS (Contractor Safety Management System) Application is a monolithic web based system designed to manage safety compliance, project documentation, and reporting. It features a responsive Single Page Application (SPA) frontend and a robust FastAPI backend. The system integrates closely with Google Drive for file storage and Supabase (PostgreSQL) for structured data persistence.

Key capabilities:
- Project & Task Management (CSMS Elements 1-9)
- Real-time Progress Tracking
- Google Drive Integration (Uploads, Folder Management, PDF Conversion)
- Automated Report Generation (Docx, Excel, PDF)
- CSMS PB (Pre-Boarding) Record Management
- Related Documents Management
- Interactive Scheduler & Calendar
- Comment threads for collaboration
- **Automated Email Reminders & Error Notifications**

2. TECHNOLOGY STACK
-------------------

2.1 Frontend
   - Language: HTML5, CSS3, JavaScript (ES6+)
   - Framework: Vanilla JS (No external framework like React/Vue)
   - Architecture: Single Page Application (SPA) embedded in `static/index.html`
   - Styling: Custom CSS with CSS Variables for theming (Dark/Light/Ocean/Forest/Sunset)
   - State Management: Local variable state within closure-like structure in `index.html`

2.2 Backend
   - Language: Python 3.12+
   - Framework: FastAPI
   - Server: Uvicorn (ASGI)
   - Database Client: supabase-py
   - Storage Client: google-api-python-client
   - Email Client: requests (Brevo API)

2.3 Database & Storage
   - Database: Supabase (PostgreSQL)
   - File Storage: Google Drive (Structured folder hierarchy)
   - Authentication: 
     - App: Client-side Admin Mode (Local Storage)
     - Drive: OAuth2 / Service Account

2.4 Infrastructure
   - Deployment Context: Vercel (Serverless friendly structure)
   - Environment Variables: Managed via `.env`

3. DIRECTORY STRUCTURE
----------------------
/Users/izzadev/.gemini/antigravity/scratch/CSMS FIX/
├── main.py                     # Application Entry Point & Route Definitions
├── config.py                   # Configuration & Constants (Standard Tasks)
├── requirements.txt            # Python Dependencies
├── vercel.json                 # Vercel Deployment Config
├── Procfile                    # Process file (for Heroku-like environments)
├── runtime.txt                 # Python Runtime version
├── .env                        # Environment Variables (Secrets)
│
├── api/                        # Vercel Serverless Entry
│   └── index.py                # Wrapper for Vercel
│
├── routers/                    # API Route Handlers
│   ├── __init__.py
│   └── reports.py              # Report Generation Routes
│
├── services/                   # Business Logic & External Integrations
│   ├── __init__.py
│   ├── google_drive.py         # Google Drive Service (Deeply Integrated)
│   ├── supabase_service.py     # Database CRUD Operations
│   ├── report_engine.py        # Report Generation Logic (Jinja2/Pandas/Docx)
│   ├── logger_service.py       # Centralized Logging & Error Notifications
│   ├── email_service.py        # Email Reminder Logic (Brevo)
│   ├── drive_template_service.py # Drive Template Management
│   └── daftar_isi_service.py   # Table of Contents Generator
│
├── static/                     # Frontend Assets
│   ├── index.html              # Main SPA Application Code
│   ├── style.css               # (Integrated in index.html)
│   ├── script.js               # (Integrated in index.html)
│   └── weatherford_logo.png    # App Logo
│
└── data/                       # Local JSON Backups (Legacy/Fallback)
    ├── projects.json
    ├── tasks.json
    └── ...

4. SYSTEM ARCHITECTURE & LOGIC
------------------------------

4.1 Frontend Architecture (`static/index.html`)
   The frontend is a massive, self-contained file acting as the view layer.
   - **Initialization**: `initApp()` loads initial data (Projects, Stats) from API.
   - **Navigation**: Drawer-based navigation switching visibility of `<section>` elements.
   - **Modules**:
     - `Dashboard`: High-level stats, charts (using Chart.js logic/SVG).
     - `Projects`: List view, creation modal, progress bars.
     - `Project Details`: Task list grouped by CSMS Elements (1-9). Drag-and-drop file upload.
     - `CSMS PB`: Pre-Boarding records, scoring context, attachment upload (chunked).
     - `Related Docs`: Document repository with resumable uploads.
   - **Admin Mode**: Toggles visibility of delete buttons and sensitive controls via `.admin-mode` CSS class and JS checks.

4.2 Backend Architecture (`main.py`)
   - **FastAPI App**: Initializes middleware (CORS) and routes.
   - **Global Exception Handler**: Catches unhandled errors and triggers `email_service` to notify admins.
   - **Endpoints**:
     - `GET /projects`, `POST /projects` ... : CRUD via `supabase_service`.
     - `POST /upload`: Handles file upload to Google Drive via `google_drive_service`.
     - `DELETE /files/{id}`: Deletes file from Drive.
     - `POST /reports/generate`: Generates reports via `reports_router`.
     - `POST /csms-pb/initiate-upload`: Starts resumable upload session.
     - `POST /csms-pb/upload-chunk`: Handles file chunks for stability.
     - `POST /api/send-reminders`: Trigger for email reminder logic.

4.3 Google Drive Integration (`services/google_drive.py`)
   A core component of the system, handling all unstructured data.
   
   **A. Authentication & Resilience**
   - **Dual Auth**: Uses OAuth2 (User context) with fallback to Service Account (Server context).
   - **Retry Mechanism**: Implements `_execute_with_retry` wrapper with exponential backoff (1s-32s) and jitter to handle SSL/Network errors (`[SSL] record layer failure`, `ConnectionResetError`, `HTTP 429/5xx`).
   
   **B. Folder Structure (Checklist Mode)**
   The system maps the CSMS Standard Elements directly to a folder hierarchy:
   1. **Root**: `CSMS Database` (Defined by `GOOGLE_DRIVE_FOLDER_ID`)
   2. **Project**: `Project Name - Well Name`
   3. **Element**: `Element X` (e.g., "Element 4")
   4. **Sub-Element**: `X.Y Description` (e.g., "4.1 Risk Management")
   5. **Task**: `X.Y.Z Task Title` (e.g., "4.1.2 Job Safety Analysis")
   
   **C. Nested Logic (`create_nested_task_folder`)**
   - Parses task codes (e.g., "4.3.2.2.1").
   - Recursively finds or creates intermediate folders using `find_or_create_folder`.
   - Uses caching (`folders_cache`) to minimize API calls during bulk operations.
   
   **D. Upload Mechanisms**
   - **Standard Upload**: Memory-based upload for small files.
   - **Chunked Upload (Proxy)**: For large files (e.g., in CSMS PB or Related Docs), the frontend uploads chunks to the FastAPI backend, which proxies them to Google Drive's Resumable Upload URL. This bypasses Vercel's 4.5MB payload limit.

4.4 Email Service & Notifications (`services/email_service.py`)
   Uses Brevo (formerly Sendinblue) API for transactional emails.
   
   **A. Reminder Logic**
   - **Trigger**: External scheduler/cron calls `POST /api/send-reminders`.
   - **Rig Down Alert**: Checks projects where `(rig_down_date - today) <= 2 days`.
     - If completion < 80%, sends "URGENT: Rig Down Imminent" email to PIC and Manager.
   - **Schedule Reminders**: Sends notifications for specific scheduled events (MWT, HSE Meeting) based on date.
   - **Templates**: HTML/CSS rich templates with color coding (Red for alerts, Blue/Green for informational).
   
   **B. Error Logging (`services/logger_service.py`)**
   - **Rate Limiting**: Prevents spamming admins by limiting error emails to 5 per 5 minutes per unique error location.
   - **Context**: Emails include full traceback, request path, and timestamp.
   - **Integration**: Global exception handler in `main.py` automatically routes 500 errors to this service.

4.5 Data Persistence (`services/supabase_service.py`)
   - Abstraction layer over Supabase Client.
   - Handles all SQL operations for tables: `projects`, `tasks`, `schedules`, `comments`, `csms_pb`, `related_docs`.
   - Includes fallback logging if Supabase is unreachable.

5. API ROUTES FRAMEWORK
-----------------------

| Method | Endpoint                        | Description                          |
|--------|---------------------------------|--------------------------------------|
| GET    | /projects                       | List all projects                    |
| POST   | /projects                       | Create new project                   |
| GET    | /projects/{id}/tasks            | Get tasks for a project              |
| POST   | /tasks/{task_code}/upload       | Upload file with nested folder logic |
| POST   | /reports/generate               | Generate consolidated report         |
| POST   | /api/send-reminders             | Trigger email reminders (Cron)       |
| GET    | /csms-pb                        | Get CSMS PB records                  |
| POST   | /csms-pb/initiate-upload        | Start attachment upload (Resumable)  |
| POST   | /csms-pb/upload-chunk           | Upload attachment chunk (Proxy)      |
| GET    | /download/{file_id}             | Proxy download from Drive            |

6. DEPENDENCIES (Library List)
------------------------------

**Core**
- `fastapi`: Web framework
- `uvicorn`: ASGI Server
- `python-dotenv`: Environment variable management
- `requests`: HTTP client (Brevo API)

**Google Integration**
- `google-auth`, `google-auth-oauthlib`, `google-auth-httplib2`: Auth flows
- `google-api-python-client`: Drive API client

**Data & File Processing**
- `supabase`: Database client
- `python-multipart`: Form data parsing
- `openpyxl`: Excel manipulation
- `python-docx`: Word document manipulation
- `pdfplumber`: PDF extraction
- `reportlab`: PDF generation
- `pillow`: Image processing

7. SECURITY
-----------
- **CORS**: Configured to allow all origins `["*"]` (Dev mode) - Should be restricted for prod.
- **Secrets**: All sensitive keys (Drive JSON, Supabase Key, Brevo Key) stored in environment variables.
- **Admin**: Frontend-gatekept admin mode (Low security, relies on obscurity/local storage). Backend delete routes for CSMS PB are protected by logic checks but rely on frontend state.

8. RECOMMENDATIONS & NEXT STEPS
-------------------------------
1. **Refactor Frontend**: The `index.html` is becoming monolithic. Consider splitting into multiple JS modules using ES6 imports or migrating to a lightweight framework like Vue.js/React for better maintainability.
2. **Backend Authentication**: Implement proper JWT-based authentication on the backend to secure Admin routes, rather than relying on frontend flags.
3. **Task Queue**: Move email sending and heavy Drive operations to a proper task queue (like Celery or Redis Queue) instead of `BackgroundTasks` if load increases.
4. **Testing**: Add unit tests for `google_drive.py` retry logic and `report_engine.py`.

End of Blueprint
